# 76. Как использовать метод peek в Stream API? - что принимает/возвращает?

Метод `peek` в Stream API используется для выполнения промежуточных действий над элементами потока (stream) без изменения самого потока. Он полезен для отладки или выполнения дополнительных операций, таких как логирование, без прерывания цепочки операций.

### Сигнатура метода:
```java
Stream<T> peek(Consumer<? super T> action)
```

### Параметры:
- `action` — это функциональный интерфейс `Consumer`, который принимает один аргумент (элемент потока) и не возвращает результат (`void`). Вы можете передать лямбда-выражение или ссылку на метод, чтобы определить действие, которое будет выполнено для каждого элемента.

### Возвращаемое значение:
- Метод `peek` возвращает **новый поток** (`Stream<T>`), содержащий те же элементы, что и исходный поток. Это позволяет продолжить цепочку операций.

### Пример использования:
```java
import java.util.List;
import java.util.stream.Collectors;

public class Main {
    public static void main(String[] args) {
        List<String> names = List.of("Alice", "Bob", "Charlie");

        // Используем peek для логирования элементов
        List<String> result = names.stream()
            .peek(name -> System.out.println("Processing: " + name)) // Логируем каждый элемент
            .map(String::toUpperCase) // Преобразуем каждый элемент в верхний регистр
            .collect(Collectors.toList()); // Собираем результат в список

        System.out.println("Result: " + result);
    }
}
```

### Вывод:
```
Processing: Alice
Processing: Bob
Processing: Charlie
Result: [ALICE, BOB, CHARLIE]
```

### Особенности:
1. **Промежуточная операция**: `peek` является промежуточной операцией (intermediate operation), поэтому он не завершает поток и позволяет продолжить цепочку вызовов.
2. **Ленивое выполнение**: Как и другие промежуточные операции, `peek` выполняется только при вызове терминальной операции (например, `collect`, `forEach`).
3. **Использование для отладки**: `peek` часто используется для отладки, чтобы увидеть состояние элементов на определённом этапе обработки потока.
4. **Побочные эффекты**: Хотя `peek` позволяет выполнять действия с побочными эффектами (например, логирование), рекомендуется избегать изменения состояния элементов или внешних переменных, так как это может привести к неожиданному поведению, особенно в параллельных потоках.

### Когда использовать:
- Для отладки или логирования элементов потока.
- Для выполнения дополнительных действий без изменения данных (например, подсчёт элементов).

### Пример с параллельным потоком:
```java
List<String> result = names.parallelStream()
    .peek(name -> System.out.println("Processing: " + name + " in thread: " + Thread.currentThread().getName()))
    .map(String::toUpperCase)
    .collect(Collectors.toList());
```

В этом случае порядок вывода сообщений может быть произвольным из-за параллельного выполнения.

### Важно:
Не используйте `peek` для изменения состояния элементов или выполнения критически важных операций, так как его поведение может быть неочевидным, особенно в параллельных потоках. Для таких задач лучше использовать `map` или `forEach`.
