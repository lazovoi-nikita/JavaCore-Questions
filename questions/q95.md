# 95. В чем особенность блока finally? Всегда ли он исполняется?

Блок **`finally`** в Java используется для выполнения кода, который должен быть выполнен **в любом случае**, независимо от того, возникло исключение или нет. Это делает его идеальным местом для освобождения ресурсов, таких как закрытие файлов, соединений с базой данных и т.д.

---

### 1. **Особенности блока `finally`**
1. **Гарантированное выполнение**:
   - Блок `finally` выполняется всегда, за исключением некоторых крайних случаев (см. ниже).
   - Это происходит независимо от того, было ли выброшено исключение, обработано ли оно или нет.

2. **Использование для cleanup-операций**:
   - Блок `finally` часто используется для освобождения ресурсов, чтобы избежать утечек памяти или других проблем.

3. **Порядок выполнения**:
   - Блок `finally` выполняется после блока `try` и, если есть, после блока `catch`.

---

### 2. **Синтаксис**
```java
try {
    // Код, который может вызвать исключение
} catch (ТипИсключения e) {
    // Обработка исключения
} finally {
    // Код, который выполнится в любом случае
}
```

---

### 3. **Пример использования**

#### Пример 1: Без исключения
```java
try {
    System.out.println("Внутри try");
} catch (Exception e) {
    System.out.println("Внутри catch");
} finally {
    System.out.println("Внутри finally");
}
```

#### Вывод:
```
Внутри try
Внутри finally
```

#### Пример 2: С исключением
```java
try {
    System.out.println("Внутри try");
    throw new Exception("Исключение");
} catch (Exception e) {
    System.out.println("Внутри catch: " + e.getMessage());
} finally {
    System.out.println("Внутри finally");
}
```

#### Вывод:
```
Внутри try
Внутри catch: Исключение
Внутри finally
```

---

### 4. **Когда блок `finally` не выполняется?**
Блок `finally` не выполняется в следующих случаях:
1. **Принудительное завершение программы**:
   - Если программа завершается принудительно (например, с помощью `System.exit()`), блок `finally` не выполняется.

   ```java
   try {
       System.out.println("Внутри try");
       System.exit(0); // Принудительное завершение программы
   } finally {
       System.out.println("Внутри finally"); // Не выполнится
   }
   ```

2. **Сбой JVM**:
   - Если происходит сбой JVM (например, из-за критической ошибки, такой как `OutOfMemoryError`), блок `finally` может не выполниться.

3. **Бесконечный цикл или зависание**:
   - Если поток выполнения зависает (например, из-за бесконечного цикла), блок `finally` не будет выполнен.

4. **Убийство потока**:
   - Если поток, выполняющий блок `try-catch-finally`, принудительно завершается (например, с помощью `Thread.stop()`), блок `finally` не выполнится.

---

### 5. **Блок `finally` и `return`**
Блок `finally` выполняется даже если в блоке `try` или `catch` есть оператор `return`. Однако есть нюансы:
- Если в блоке `finally` есть свой `return`, он переопределит возвращаемое значение из `try` или `catch`.

#### Пример 1: Без `return` в `finally`
```java
public static int example() {
    try {
        return 1;
    } finally {
        System.out.println("Внутри finally");
    }
}

public static void main(String[] args) {
    System.out.println(example());
}
```

#### Вывод:
```
Внутри finally
1
```

#### Пример 2: С `return` в `finally`
```java
public static int example() {
    try {
        return 1;
    } finally {
        System.out.println("Внутри finally");
        return 2; // Переопределяет возвращаемое значение
    }
}

public static void main(String[] args) {
    System.out.println(example());
}
```

#### Вывод:
```
Внутри finally
2
```

---

### 6. **Блок `finally` и исключения**
Если в блоке `finally` возникает исключение, оно переопределяет исключение, выброшенное в блоке `try` или `catch`.

#### Пример:
```java
try {
    throw new RuntimeException("Исключение в try");
} finally {
    throw new RuntimeException("Исключение в finally");
}
```

#### Вывод:
```
Exception in thread "main" java.lang.RuntimeException: Исключение в finally
```

---

### Итог:
- Блок `finally` выполняется всегда, за исключением случаев принудительного завершения программы, сбоя JVM или зависания.
- Он используется для cleanup-операций, таких как освобождение ресурсов.
- Если в блоке `finally` есть `return`, он переопределяет возвращаемое значение из `try` или `catch`.
- Если в блоке `finally` возникает исключение, оно переопределяет исключение из `try` или `catch`.

Таким образом, блок `finally` — это мощный инструмент для обеспечения выполнения критически важного кода, но его использование требует осторожности.
